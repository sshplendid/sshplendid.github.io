<!doctype HTML>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="app">
      <header>
        <h1>내게 필요한 칼로리를 계산해보자!</h1>
      </header>
      <section>
        <div id="survey">
          <p>
            나는  
            <input id="age" type="number" min="0" max="200" placeholder="나이"/>
            살 
            <select id="gender">
              <option value="">선택</option>
              <option value="male">남성</option>
              <option value="female">여성</option>
            </select>
            입니다.
            </p>
            <p>그리고 키는 
            <input id="height" type="number" min="0" max="300" placeholder="키"/>
            cm, 체중은
            <input id="weight" type="number" min="0" max="500" placeholder="체중"/>
            kg 입니다.
            <!-- 기초대사 = 10 * 체중 + 6.25 * 신장 - 5 * 나이 + (gender == 'male') ? 5 : -161 -->
          </p>
          
          <p>
            나는 활동레벨이 
              <select id="activity">
              <option value="">선택</option>
              <option value="low">낮은</option>
              <option value="normal">보통의</option>
              <option value="high">높은</option>
            </select>
            상태이고, 앞으로 
            <!-- 활동대사량 = 활동레벨 * 기초대사 -->
            <select id="purpose">
              <option value="">선택</option>
              <option value="bulkup">벌크업</option>
              <option value="stay">현상유지</option>
              <option value="reduce">체중감량</option>
            </select>
            <!-- 하루 섭취칼로리 = 하루 소비칼로리 * 목적 -->
            목적으로 칼로리를 계산하겠습니다.
          </p>
          <label for="activity-desc">활동레벨의 기준</label>
          <ul name="activity-desc">
            <li>주로 앉아서 일하며, 하루에 하는 운동은 걷거나 계단을 올라가는 정도.</li>
            <li>서서 하는 일이나 중노동이 많고, 비교적 하루종일 돌아다니는 편.</li>
            <li>서서 하는 일이나 중노동이 많고, 추가로 헬스장에서 트레이닝을 하거나 운동을 한다.</li>
          </ul>
        </div>
        <div id="calculator">
          <h1>당신의 기초대사량: <span id="bmr"></span></h1>
          <h1>당신의 활동대사량: <span id="amr"></span></h1>
          <h1>하루 섭취해야하는 칼로리: <span id="calories"></span></h1>
          <h1>탄수화물 섭취량: <span id="carbo"></span></h1>
          <h1>단백질 섭취량: <span id="protein"></span></h1>
          <h1>지방 섭취량: <span id="fat"></span></h1>
          <!--
            매크로 영양소 산출
            1. 단백질 = 체중 * 2 (g)
            2. 지방 = 칼로리 * 0.25
            3. 탄수화물 = 총 칼로리 - (단백질 + 지방)(kcal)
          -->
        </div>
        <div id="share">
          <h1>공유하기</h1>
        </div>

      </section>
      <footer>
        
      </footer>
    </div>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/babel">
      'use strict';
      console.debug = (message) => console.log(message);

      const get = function(obj, prop) {
        if(!obj || !prop) return undefined;
        const val = obj[prop] || undefined;
        return val;
      };
      const set = function(obj, prop, val) {
        if(!obj || !prop ) return;
        obj[prop] = val;
      };

      const forEach = function(arr, fn) {
        const newArr = [];
        for(i in arr) {
          newArr.push(fn(arr[i]));
        }
        return newArr;
      };
      const map = function(arr, mapper) {
        return forEach(arr, mapper);
      };
      const filter = function(arr, predicate) {
        return forEach(arr, predicate);
      };
      const reduce = function(arr, accumulate) {
        return forEach(arr, accumulate);
      };

      const getElement = function(id) {
        return document.getElementById(id);
      };

      const parse = (query, joiner, separator) => {
        return query.split(joiner)
                    .map(q => {
                      const key = q.split(separator)[0];
                      const val = q.split(separator)[1];
                      const obj = {};
                      obj[key] = val;
                      return obj;
                    })
                    .reduce((a, b) => Object.assign(a, b));
      };
      
      const Calculator = function() {
        const GENDER = Symbol();
        const HEIGHT = Symbol();
        const WEIGHT = Symbol();
        const AGE = Symbol();
        const ACTIVITY = Symbol();
        const PURPOSE = Symbol();
        const activity = {low: 1.2, normal: 1.55, high: 1.725};
        const purpose = {bulkup: 1.2, stay: 1, reduce: 0.8};

        class Calculator {
          constructor(gender, age, height, weight, activity, purpose) {
            this[GENDER] = gender;
            this[HEIGHT] = height;
            this[WEIGHT] = weight;
            this[AGE] = age;
            this[ACTIVITY] = activity;
            this[PURPOSE] = purpose;
            console.debug(`Calculator instance is just created!`);
          }

          // getter, setter
          get gender() {
            const val = this[GENDER];
            console.debug(`value:gender of Calculator is just called! ${val}` );
            return val;
          }
          set gender(val) {
            console.debug(`value:gender of Calculator is just changed! ${val}` );
            this[GENDER] = val;
            set(getElement('gender'), 'value', val);
            this.refresh();
          }
          get height() {
            const val = this[HEIGHT];
            console.debug(`value:HEIGHT of Calculator is just called! ${val}` );
            return val;
          }
          set height(val) {
            console.debug(`value:HEIGHT of Calculator is just changed! ${val}` );
            this[HEIGHT] = val;
            set(getElement('height'), 'value', val);
            this.refresh();
          }
          get weight() {
            const val = this[WEIGHT];
            console.debug(`value:WEIGHT of Calculator is just called! ${val}` );
            return val;
          }
          set weight(val) {
            console.debug(`value:WEIGHT of Calculator is just changed! ${val}` );
            this[WEIGHT] = val;
            set(getElement('weight'), 'value', val);
            this.refresh();
          }
          get age() {
            const val = this[AGE];
            console.debug(`value:AGE of Calculator is just called! ${val}` );
            return val;
          }
          set age(val) {
            console.debug(`value:AGE of Calculator is just changed! ${val}` );
            this[AGE] = val;
            set(getElement('age'), 'value', val);
            this.refresh();
          }
          get activity() {
            const val = this[ACTIVITY];
            console.debug(`value:ACTIVITY of Calculator is just called! ${val}` );
            return val;
          }
          set activity(val) {
            console.debug(`value:ACTIVITY of Calculator is just changed! ${val}` );
            this[ACTIVITY] = activity[val];
            set(getElement('activity'), 'value', val);
            this.refresh();
          }
          get purpose() {
            const val = this[PURPOSE];
            console.debug(`value:PURPOSE of Calculator is just called! ${val}` );
            return val;
          }
          set purpose(val) {
            console.debug(`value:PURPOSE of Calculator is just changed! ${val}` );
            this[PURPOSE] = purpose[val];
            set(getElement('purpose'), 'value', val);
            this.refresh();
          }

          // other methods
          isEmpty(keys) {
            return keys.map(key => !this[key]).reduce((a, b) => a || b, false);
          }
          isNotEmpty(keys) {
            return !(this.isEmpty(keys));
          }
          refreshBMR () {
            if( this.isEmpty([GENDER, AGE, HEIGHT, WEIGHT]) ) return;
            set(getElement('bmr'), 'innerText', `${this.bmr.toFixed(0)} kcal`);
          }
          
          refreshAMR() {
            if( this.isEmpty([GENDER, AGE, HEIGHT, WEIGHT, ACTIVITY]) ) return;
            set(getElement('amr'), 'innerText', `${this.amr.toFixed(0)} kcal`);
          }
          refresh() {
            this.refreshBMR();
            this.refreshAMR();

            if( this.isEmpty([GENDER, AGE, HEIGHT, WEIGHT, ACTIVITY, PURPOSE]) ) return;
            set(getElement('calories'), 'innerText', `${this.calories.toFixed(0)} kcal`);
            set(getElement('protein'), 'innerText', `${(this.protein/4).toFixed(0)} g (${(this.protein).toFixed(0)} kcal)`);
            set(getElement('carbo'), 'innerText', `${(this.carbo/4).toFixed(0)} g (${(this.carbo).toFixed(0)} kcal)`);
            set(getElement('fat'), 'innerText', `${(this.fat/9).toFixed(0)} g (${(this.fat).toFixed(0)} kcal)`);
          }
          
          // computed
          get bmr() {
            return 10 * this[WEIGHT] + 6.25 * this[HEIGHT] - 5 * this[AGE] + ((this[GENDER] == 'male') ? 5 : -161);
          }
          get amr () {
            return this[ACTIVITY] * this.bmr;
          }
          get calories() {
            return this.amr * this[PURPOSE];
          }
          get protein () {
            return this[WEIGHT] * 2 * 4;
          }
          get carbo() {
            return this.calories - (this.protein + this.fat);
          }
          get fat() {
            return this.calories * 0.25;
          }
        }
        const calculator = new Calculator();
        

        
        { // BIND
          Object.defineProperty(getElement('gender'), 'v-value', {
            get: function() {
              var val = calculator.gender;
              console.debug(`element[gender] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[gender] is changed! ${val}`)
              calculator.gender = val;
            }
          });
          getElement('gender').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 
          
          Object.defineProperty(getElement('weight'), 'v-value', {
            get: function() {
              var val = calculator.weight;
              console.debug(`element[weight] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[weight] is changed! ${val}`)
              calculator.weight = val;
            }
          });
          getElement('weight').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 

          Object.defineProperty(getElement('height'), 'v-value', {
            get: function() {
              var val = calculator.height;
              console.debug(`element[height] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[height] is changed! ${val}`)
              calculator.height = val;
            }
          });
          getElement('height').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 

          Object.defineProperty(getElement('age'), 'v-value', {
            get: function() {
              var val = calculator.age;
              console.debug(`element[age] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[age] is changed! ${val}`)
              calculator.age = val;
            }
          });
          getElement('age').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 

          Object.defineProperty(getElement('activity'), 'v-value', {
            get: function() {
              var val = calculator.activity;
              console.debug(`element[activity] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[activity] is changed! ${val}`)
              calculator.activity = val;
            }
          });
          getElement('activity').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 

          Object.defineProperty(getElement('purpose'), 'v-value', {
            get: function() {
              var val = calculator.purpose;
              console.debug(`element[purpose] is called! ${val}`)
              return val;
            },
            set: function(val) {
              console.debug(`element[purpose] is changed! ${val}`)
              calculator.purpose = val;
            }
          });
          getElement('purpose').onchange = function() { 
            this['v-value'] = this.value;
            console.debug(`elem is changed! ${this['v-value']}`);
          }; 
        }

        return calculator;
      };
      
      const calculator = new Calculator();
      const parameters = parse(parse(window.location.href.split('?')[1], '&', '=').q, ',', ':');
      calculator.gender = get(parameters, 'gender');
      calculator.age = get(parameters, 'age');
      calculator.weight = get(parameters, 'weight');
      calculator.height = get(parameters, 'height');
      calculator.activity = get(parameters, 'activity');
      calculator.purpose = get(parameters, 'purpose');
    </script>
  </body>
</html>